<?xml version="1.0" encoding="utf-8"?>
<CodeSnippets>
  <Code Content="Add-PSSnapin Microsoft.SharePoint.PowerShell -ErrorAction SilentlyContinue&#xD;&#xA;&#xD;&#xA;# ====================================================================================&#xD;&#xA;# Func: Get-AdministratorsGroup&#xD;&#xA;# Desc: Returns the actual (localized) name of the built-in Administrators group&#xD;&#xA;# From: Taken from the AutoSPInstaller project: http://autospinstaller.codeplex.com&#xD;&#xA;# ====================================================================================&#xD;&#xA;&#xD;&#xA;Function Get-AdministratorsGroup&#xD;&#xA;{&#xD;&#xA;    If(!$builtinAdminGroup)&#xD;&#xA;    {&#xD;&#xA;        $builtinAdminGroup = (Get-WmiObject -Class Win32_Group -computername $env:COMPUTERNAME -Filter &quot;SID='S-1-5-32-544' AND LocalAccount='True'&quot; -errorAction &quot;Stop&quot;).Name&#xD;&#xA;    }&#xD;&#xA;    Return $builtinAdminGroup&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;# ====================================================================================&#xD;&#xA;# ScriptBlock: AlterDB&#xD;&#xA;# Description: PowerShell script block passed to the SQL server&#xD;&#xA;# ====================================================================================&#xD;&#xA;&#xD;&#xA;[ScriptBlock] $global:AlterDB = {&#xD;&#xA;&#xD;&#xA;    param ([string] $DBName,[string] $LoginName)&#xD;&#xA;&#xD;&#xA;    # Create our SQL query to fix db permissions&#xD;&#xA;    [string] $dbCommand = &quot;ALTER AUTHORIZATION ON DATABASE::[$DBname] TO [$LoginName];&quot;&#xD;&#xA;&#xD;&#xA;    # Attempt to get SQL cmdlets&#xD;&#xA;    $SQLSnapins = Get-PSSnapin -registered | Where-Object {$_.Name -like &quot;SqlServer*&quot;}&#xD;&#xA;    $SQLModules = Get-Module | Where-Object {$_.Name -like &quot;SQL*&quot;}&#xD;&#xA;    $SQLcmdlets = $false&#xD;&#xA;&#xD;&#xA;    # Check to see if a snapin for the SQL cmdlets exists (versions prior to SQL 2012)&#xD;&#xA;    if($SQLSnapins -ne $null)&#xD;&#xA;    {&#xD;&#xA;        foreach($Snapin in $SQLSnapins)&#xD;&#xA;        {&#xD;&#xA;            Add-PSSnapin $Snapin | Out-Null&#xD;&#xA;        }&#xD;&#xA;        $SQLcmdlets = $true&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    # If no snapin, check for SQL module (SQL 2012+)&#xD;&#xA;    elseif($SQLModules -ne $null)&#xD;&#xA;    {&#xD;&#xA;        foreach($Module in $SQLModules)&#xD;&#xA;        {&#xD;&#xA;            Import-Module SQLPS | Out-Null&#xD;&#xA;        } &#xD;&#xA;        $SQLcmdlets = $true            &#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    # Display warning if no SQL cmdlets available&#xD;&#xA;    else&#xD;&#xA;    {&#xD;&#xA;        Write-Host &quot;No SQL cmdlets found!&quot; -ForegroundColor Yellow&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    # If SQL cmdlets available, execute our query&#xD;&#xA;    if($SQLcmdlets -eq $true)&#xD;&#xA;    {&#xD;&#xA;        Invoke-SqlCmd -Query $dbCommand&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&lt;#&#xD;&#xA;.SYNOPSIS&#xD;&#xA;Reprovisions the User Profile Synchronization Service&#x9;&#xD;&#xA;&#xD;&#xA;.DESCRIPTION&#xD;&#xA;This function fixes the SharePoint user profile synchronization service not starting by reprovisioning the User Profile Synchronization Service. DBcreator and SecurityAdmin access to the SharePoint SQL server are required, as well as local administrator on the SharePoint application server. You'll also need to be able to invoke a remote PowerShell session on the SQL server. In addition, you will have to recreate your synchronization connections afterward (I hope to automate this in a future release of this script).&#xD;&#xA;&#xD;&#xA;.EXAMPLE&#xD;&#xA;Fix-SPUserProfileSync -FarmAdmin &quot;DOMAIN\SP_farm&quot; -FarmPassword &quot;FARM_password&quot; -DBServer &quot;DBServerName&quot;&#xD;&#xA;&#xD;&#xA;This command takes three required parameters and resets the synchronisation database. &quot;DBServerName&quot; can be an alias or the actual SQL server name.&#xD;&#xA;&#xD;&#xA;.NOTES&#xD;&#xA;NAME: Fix-SPUserProfileSync&#xD;&#xA;AUTHOR: Wes Kroesbergen&#xD;&#xA;CAVEATS: DBcreator and SecurityAdmin access to the SharePoint SQL server are required, as well as local administrator on the SharePoint application server. You'll also need to be able to invoke a remote PowerShell session on the SQL server. In addition, you will have to recreate your synchronization connections afterward (I hope to automate this in a future release of this script).&#xD;&#xA;&#xD;&#xA;.LINK&#xD;&#xA;http://www.kroesbergens.com&#xD;&#xA;#&gt;&#xD;&#xA;&#xD;&#xA;Function Fix-SPUserProfileSync&#xD;&#xA;{&#xD;&#xA;    Param([Parameter(Position=0,Mandatory=$true)][string] $FarmAdmin,&#xD;&#xA;        [Parameter(Position=1,Mandatory=$true)][string] $FarmPassword,&#xD;&#xA;        [Parameter(Position=2,Mandatory=$true)][string] $DBServer)&#xD;&#xA;&#xD;&#xA;    $FarmPassword = ConvertTo-SecureString $FarmPassword -AsPlainText -Force    &#xD;&#xA;    $farmAcctDomain,$farmAcctUser = $farmAdmin -Split &quot;\\&quot;&#xD;&#xA;    $builtinAdminGroup = Get-AdministratorsGroup&#xD;&#xA;&#xD;&#xA;    # Elevate privileges if necessary&#xD;&#xA;    Try&#xD;&#xA;    {        &#xD;&#xA;        ([ADSI]&quot;WinNT://$env:COMPUTERNAME/$builtinAdminGroup,group&quot;).Add(&quot;WinNT://$farmAcctDomain/$farmAcctUser&quot;)&#xD;&#xA;        If (-not $?) {Throw}&#xD;&#xA;        # Restart the SPTimerV4 service if it's running, so it will pick up the new credential&#xD;&#xA;        If ((Get-Service -Name SPTimerV4).Status -eq &quot;Running&quot;)&#xD;&#xA;        {&#xD;&#xA;            Write-Host -ForegroundColor White &quot; - Restarting SharePoint Timer Service...&quot;&#xD;&#xA;            Restart-Service SPTimerV4&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;    Catch {Write-Host -ForegroundColor White &quot; - $FarmAdmin is already a member of `&quot;$builtinAdminGroup`&quot;.&quot;}&#xD;&#xA;&#xD;&#xA;    # Stop the Timer Service&#xD;&#xA;    Stop-Service sptimerv4&#xD;&#xA;&#xD;&#xA;    # Get the Sync DB and clear the data&#xD;&#xA;    $SyncDB=Get-SPDatabase | Where-Object {$_.Type -eq &quot;Microsoft.Office.Server.Administration.SynchronizationDatabase&quot;}&#xD;&#xA;    $SyncDB.Unprovision()&#xD;&#xA;    $SyncDB.Status='Offline'&#xD;&#xA;&#xD;&#xA;    # Reset the Sync info in the User Profile Application&#xD;&#xA;    $UPA=Get-SPServiceApplication | Where-Object {$_.TypeName -match &quot;User Profile Service Application&quot;}&#xD;&#xA;    $UPA.ResetSynchronizationMachine()&#xD;&#xA;    $UPA.ResetSynchronizationDatabase()&#xD;&#xA;&#xD;&#xA;    # Reprovision the Sync DB&#xD;&#xA;    $SyncDB.Provision()&#xD;&#xA;&#xD;&#xA;    $UPSinstance = Get-SPServiceInstance | Where-Object {$_.TypeName -match &quot;User Profile Synchronization Service&quot; }&#xD;&#xA;    $UPA.SetSynchronizationMachine($env:COMPUTERNAME, $UPSinstance.ID, $FarmAdmin, $FarmPassword)&#xD;&#xA;    Start-SPServiceInstance -Identity $UPSinstance.ID &#xD;&#xA;&#xD;&#xA;    # Before we try to connect remotely, let's confirm DBServer is not an alias&#xD;&#xA;    $AliasPath = &quot;HKLM:\Software\Microsoft\MSSQLServer\Client\ConnectTo\&quot;&#xD;&#xA;    $Item = Get-ItemProperty -Path $AliasPath -Name $DBServer&#xD;&#xA;    if ((test-path -path $AliasPath) -eq $True)&#xD;&#xA;    {&#xD;&#xA;        write-host &quot;Alias exists!&quot;&#xD;&#xA;&#xD;&#xA;        # If object exists, we parse the definitions and retrieve the one with a TCP alias value&#xD;&#xA;        $AliasProperties = ($Item | Get-Member | Where-Object {$_.Definition -like &quot;*DBMSSOCN*&quot;}).Definition.Split(&quot;,&quot;)&#xD;&#xA;        $DBServer = $AliasProperties[1]&#xD;&#xA;        Write-Host &quot;Actual server name is $DBServer!&quot; -ForegroundColor Yellow&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    # Make sure the farm account has DBO rights to Sync DB&#xD;&#xA;    Invoke-Command -ComputerName $DBServer -ScriptBlock $AlterDB -ArgumentList $SyncDB,$FarmAdmin&#xD;&#xA;&#xD;&#xA;    # Start the Timer Service&#xD;&#xA;    Start-Service sptimerv4&#xD;&#xA;&#xD;&#xA;    # Remove farm account from local admin&#xD;&#xA;    Write-Host -ForegroundColor White &quot; - Removing $FarmAdmin from local group `&quot;$builtinAdminGroup`&quot;...&quot;&#xD;&#xA;        &#xD;&#xA;    try&#xD;&#xA;    {&#xD;&#xA;        ([ADSI]&quot;WinNT://$env:COMPUTERNAME/$builtinAdminGroup,group&quot;).Remove(&quot;WinNT://$farmAcctDomain/$farmAcctUser&quot;)&#xD;&#xA;        If (-not $?) {throw}&#xD;&#xA;    }&#xD;&#xA;    catch {Write-Host -ForegroundColor White &quot; - $FarmAdmin already removed from `&quot;$builtinAdminGroup.`&quot;&quot;}&#xD;&#xA;&#xD;&#xA;    # Restart SPTimerV4 so it can now run under non-local Admin privileges and avoid Health Analyzer warning&#xD;&#xA;    Write-Host -ForegroundColor White &quot; - Starting SharePoint Timer Service...&quot;&#xD;&#xA;&#xD;&#xA;    Restart-Service SPTimerV4&#xD;&#xA;}" />
  <Code Content="Add-PSSnapin Microsoft.SharePoint.PowerShell -ErrorAction SilentlyContinue&#xD;&#xA;&#xD;&#xA;# ====================================================================================&#xD;&#xA;# Func: Get-AdministratorsGroup&#xD;&#xA;# Desc: Returns the actual (localized) name of the built-in Administrators group&#xD;&#xA;# From: Taken from the AutoSPInstaller project: http://autospinstaller.codeplex.com&#xD;&#xA;# ====================================================================================&#xD;&#xA;&#xD;&#xA;Function Get-AdministratorsGroup&#xD;&#xA;{&#xD;&#xA;    If(!$builtinAdminGroup)&#xD;&#xA;    {&#xD;&#xA;        $builtinAdminGroup = (Get-WmiObject -Class Win32_Group -computername $env:COMPUTERNAME -Filter &quot;SID='S-1-5-32-544' AND LocalAccount='True'&quot; -errorAction &quot;Stop&quot;).Name&#xD;&#xA;    }&#xD;&#xA;    Return $builtinAdminGroup&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;# ====================================================================================&#xD;&#xA;# ScriptBlock: AlterDB&#xD;&#xA;# Description: PowerShell script block passed to the SQL server&#xD;&#xA;# ====================================================================================&#xD;&#xA;&#xD;&#xA;[ScriptBlock] $global:AlterDB = {&#xD;&#xA;&#xD;&#xA;    param ([string] $DBName,[string] $LoginName)&#xD;&#xA;&#xD;&#xA;    # Create our SQL query to fix db permissions&#xD;&#xA;    [string] $dbCommand = &quot;ALTER AUTHORIZATION ON DATABASE::[$DBname] TO [$LoginName];&quot;&#xD;&#xA;&#xD;&#xA;    # Attempt to get SQL cmdlets&#xD;&#xA;    $SQLSnapins = Get-PSSnapin -registered | Where-Object {$_.Name -like &quot;SqlServer*&quot;}&#xD;&#xA;    $SQLModules = Get-Module | Where-Object {$_.Name -like &quot;SQL*&quot;}&#xD;&#xA;    $SQLcmdlets = $false&#xD;&#xA;&#xD;&#xA;    # Check to see if a snapin for the SQL cmdlets exists (versions prior to SQL 2012)&#xD;&#xA;    if($SQLSnapins -ne $null)&#xD;&#xA;    {&#xD;&#xA;        foreach($Snapin in $SQLSnapins)&#xD;&#xA;        {&#xD;&#xA;            Add-PSSnapin $Snapin | Out-Null&#xD;&#xA;        }&#xD;&#xA;        $SQLcmdlets = $true&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    # If no snapin, check for SQL module (SQL 2012+)&#xD;&#xA;    elseif($SQLModules -ne $null)&#xD;&#xA;    {&#xD;&#xA;        foreach($Module in $SQLModules)&#xD;&#xA;        {&#xD;&#xA;            Import-Module SQLPS | Out-Null&#xD;&#xA;        } &#xD;&#xA;        $SQLcmdlets = $true            &#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    # Display warning if no SQL cmdlets available&#xD;&#xA;    else&#xD;&#xA;    {&#xD;&#xA;        Write-Host &quot;No SQL cmdlets found!&quot; -ForegroundColor Yellow&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    # If SQL cmdlets available, execute our query&#xD;&#xA;    if($SQLcmdlets -eq $true)&#xD;&#xA;    {&#xD;&#xA;        Invoke-SqlCmd -Query $dbCommand&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&lt;#&#xD;&#xA;.SYNOPSIS&#xD;&#xA;Reprovisions the User Profile Synchronization Service&#x9;&#xD;&#xA;&#xD;&#xA;.DESCRIPTION&#xD;&#xA;This function fixes the SharePoint user profile synchronization service not starting by reprovisioning the User Profile Synchronization Service. DBcreator and SecurityAdmin access to the SharePoint SQL server are required, as well as local administrator on the SharePoint application server. You'll also need to be able to invoke a remote PowerShell session on the SQL server. In addition, you will have to recreate your synchronization connections afterward (I hope to automate this in a future release of this script).&#xD;&#xA;&#xD;&#xA;.EXAMPLE&#xD;&#xA;Fix-SPUserProfileSync -FarmAdmin &quot;DOMAIN\SP_farm&quot; -FarmPassword &quot;FARM_password&quot; -DBServer &quot;DBServerName&quot;&#xD;&#xA;&#xD;&#xA;This command takes three required parameters and resets the synchronisation database. &quot;DBServerName&quot; can be an alias or the actual SQL server name.&#xD;&#xA;&#xD;&#xA;.NOTES&#xD;&#xA;NAME: Fix-SPUserProfileSync&#xD;&#xA;AUTHOR: Wes Kroesbergen&#xD;&#xA;CAVEATS: DBcreator and SecurityAdmin access to the SharePoint SQL server are required, as well as local administrator on the SharePoint application server. You'll also need to be able to invoke a remote PowerShell session on the SQL server. In addition, you will have to recreate your synchronization connections afterward (I hope to automate this in a future release of this script).&#xD;&#xA;&#xD;&#xA;.LINK&#xD;&#xA;http://www.kroesbergens.com&#xD;&#xA;#&gt;&#xD;&#xA;&#xD;&#xA;Function Fix-SPUserProfileSync&#xD;&#xA;{&#xD;&#xA;    Param([Parameter(Position=0,Mandatory=$true)][string] $FarmAdmin,&#xD;&#xA;        [Parameter(Position=1,Mandatory=$true)][string] $FarmPassword,&#xD;&#xA;        [Parameter(Position=2,Mandatory=$true)][string] $DBServer)&#xD;&#xA;&#xD;&#xA;    $FarmPassword = ConvertTo-SecureString $FarmPassword -AsPlainText -Force    &#xD;&#xA;    $farmAcctDomain,$farmAcctUser = $farmAdmin -Split &quot;\\&quot;&#xD;&#xA;    $builtinAdminGroup = Get-AdministratorsGroup&#xD;&#xA;&#xD;&#xA;    # Elevate privileges if necessary&#xD;&#xA;    Try&#xD;&#xA;    {        &#xD;&#xA;        ([ADSI]&quot;WinNT://$env:COMPUTERNAME/$builtinAdminGroup,group&quot;).Add(&quot;WinNT://$farmAcctDomain/$farmAcctUser&quot;)&#xD;&#xA;        If (-not $?) {Throw}&#xD;&#xA;        # Restart the SPTimerV4 service if it's running, so it will pick up the new credential&#xD;&#xA;        If ((Get-Service -Name SPTimerV4).Status -eq &quot;Running&quot;)&#xD;&#xA;        {&#xD;&#xA;            Write-Host -ForegroundColor White &quot; - Restarting SharePoint Timer Service...&quot;&#xD;&#xA;            Restart-Service SPTimerV4&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;    Catch {Write-Host -ForegroundColor White &quot; - $FarmAdmin is already a member of `&quot;$builtinAdminGroup`&quot;.&quot;}&#xD;&#xA;&#xD;&#xA;    # Stop the Timer Service&#xD;&#xA;    Stop-Service sptimerv4&#xD;&#xA;&#xD;&#xA;    # Get the Sync DB and clear the data&#xD;&#xA;    $SyncDB=Get-SPDatabase | Where-Object {$_.Type -eq &quot;Microsoft.Office.Server.Administration.SynchronizationDatabase&quot;}&#xD;&#xA;    $SyncDB.Unprovision()&#xD;&#xA;    $SyncDB.Status='Offline'&#xD;&#xA;&#xD;&#xA;    # Reset the Sync info in the User Profile Application&#xD;&#xA;    $UPA=Get-SPServiceApplication | Where-Object {$_.TypeName -match &quot;User Profile Service Application&quot;}&#xD;&#xA;    $UPA.ResetSynchronizationMachine()&#xD;&#xA;    $UPA.ResetSynchronizationDatabase()&#xD;&#xA;&#xD;&#xA;    # Reprovision the Sync DB&#xD;&#xA;    $SyncDB.Provision()&#xD;&#xA;&#xD;&#xA;    $UPSinstance = Get-SPServiceInstance | Where-Object {$_.TypeName -match &quot;User Profile Synchronization Service&quot; }&#xD;&#xA;    $UPA.SetSynchronizationMachine($env:COMPUTERNAME, $UPSinstance.ID, $FarmAdmin, $FarmPassword)&#xD;&#xA;    Start-SPServiceInstance -Identity $UPSinstance.ID &#xD;&#xA;&#xD;&#xA;    # Before we try to connect remotely, let's confirm DBServer is not an alias&#xD;&#xA;    $AliasPath = &quot;HKLM:\Software\Microsoft\MSSQLServer\Client\ConnectTo\&quot;&#xD;&#xA;    $Item = Get-ItemProperty -Path $AliasPath -Name $DBServer&#xD;&#xA;    if ((test-path -path $AliasPath) -eq $True)&#xD;&#xA;    {&#xD;&#xA;        write-host &quot;Alias exists!&quot;&#xD;&#xA;&#xD;&#xA;        # If object exists, we parse the definitions and retrieve the one with a TCP alias value&#xD;&#xA;        $AliasProperties = ($Item | Get-Member | Where-Object {$_.Definition -like &quot;*DBMSSOCN*&quot;}).Definition.Split(&quot;,&quot;)&#xD;&#xA;        $DBServer = $AliasProperties[1]&#xD;&#xA;        Write-Host &quot;Actual server name is $DBServer!&quot; -ForegroundColor Yellow&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    # Make sure the farm account has DBO rights to Sync DB&#xD;&#xA;    Invoke-Command -ComputerName $DBServer -ScriptBlock $AlterDB -ArgumentList $SyncDB,$FarmAdmin&#xD;&#xA;&#xD;&#xA;    # Start the Timer Service&#xD;&#xA;    Start-Service sptimerv4&#xD;&#xA;&#xD;&#xA;    # Remove farm account from local admin&#xD;&#xA;    Write-Host -ForegroundColor White &quot; - Removing $FarmAdmin from local group `&quot;$builtinAdminGroup`&quot;...&quot;&#xD;&#xA;        &#xD;&#xA;    try&#xD;&#xA;    {&#xD;&#xA;        ([ADSI]&quot;WinNT://$env:COMPUTERNAME/$builtinAdminGroup,group&quot;).Remove(&quot;WinNT://$farmAcctDomain/$farmAcctUser&quot;)&#xD;&#xA;        If (-not $?) {throw}&#xD;&#xA;    }&#xD;&#xA;    catch {Write-Host -ForegroundColor White &quot; - $FarmAdmin already removed from `&quot;$builtinAdminGroup.`&quot;&quot;}&#xD;&#xA;&#xD;&#xA;    # Restart SPTimerV4 so it can now run under non-local Admin privileges and avoid Health Analyzer warning&#xD;&#xA;    Write-Host -ForegroundColor White &quot; - Starting SharePoint Timer Service...&quot;&#xD;&#xA;&#xD;&#xA;    Restart-Service SPTimerV4&#xD;&#xA;}" />
</CodeSnippets>