<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head>
        <title>Create SharePoint 2013 Claims Web Application With PowerShell</title>        
        <meta name="description" content="This script will create claims-based web applications in SharePoint 2013.&#160; This script may also work in SharePoint 2010.&#160; This script will also set your object cache user accounts, as well as configuring your object cache accounts for your web applications." />
        <link href="https://i1.code.msdn.s-msft.com/RequestReduceContent/c82dc8ab865be0fb7316b2e09ac97654-bafb67d64bd55a2b1fd123070a82b424-RequestReducedStyle.css" rel="Stylesheet" type="text/css" />        
        <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.6.1.min.js" type="text/javascript" ></script>
        <script src="https://i1.code.msdn.s-msft.com/RequestReduceContent/a12c72272a8fe142a00d8aae0ff5525e-cf9957f54e208c66abb738158989dd84-RequestReducedScript.js" type="text/javascript" ></script>                        <script type="text/javascript">
            function initializePage() {
                var activeTabData = 'activeTab';
                var otherTabClass = 'otherTab';
                var hiddenPreClass = 'hidden';
                $("a[href^=#]").attr("target","_self");
                $("div.scriptcode").each(function (i) {
                    var scriptBlock = $(this);
                    scriptBlock.trackCopy(trackCodeSnippetCodeDownload);
                    var labelElems = scriptBlock.find("div.title > span");
                    if (labelElems.length == 0) {
                        labelElems = scriptBlock.find("div.title");
                    }
                    var languageSpans = scriptBlock.find("span.hidden");
                    var pres = scriptBlock.find("pre");
                    if (languageSpans.length > 0 && pres.length > 1) {
                        labelElems.each(function(index, elem) {
                            var codePre = $(pres[index]);
                            var labelSpan = $(elem);
                            var languageSpan = $(languageSpans[index]);
                            labelSpan.data('code', codePre.text().replace(/(\r(\n)?)|((\r)?\n)/ig, '\r\n'));
                            codePre.removeClass(hiddenPreClass);  
                            codePre.addClass(languageSpan.text().replace(/^\s+|\s+$/g,""));
                            codePre.chili();
                            languageSpan.remove();
                        });

                        pres = scriptBlock.find("pre");
                        labelElems.each(function(index, elem) {
                            var codePre = $(pres[index]);
                            var labelSpan = $(elem);
                            if (index == 0) {
                                scriptBlock.data(activeTabData, 0);
                            }
                            else {
                                labelSpan.addClass(otherTabClass);
                                codePre.addClass(hiddenPreClass);  
                            }
                            labelSpan.click(function (e) {
                                var activeTab = scriptBlock.data(activeTabData);
                                $(labelElems[activeTab]).addClass(otherTabClass);   
                                $(pres[activeTab]).addClass(hiddenPreClass);   
                                        
                                codePre.removeClass(hiddenPreClass);    
                                labelSpan.removeClass(otherTabClass);
                                scriptBlock.data(activeTabData, index);

                                if( window.parent.Galleries ) {
                                    window.parent.Galleries.project.resizeDesc();
                                }
                            });
                        });

                        var preview = scriptBlock.find('div.preview');
                        if (preview.length == 0) {
                            preview = $(pres[pres.length - 1]);
                        }
                        preview.remove();

                        if (window.clipboardData && clipboardData.setData) {
                            var copyLink = $("<a href='#' class='copyCode'>Copy code</a>");
                            copyLink.click(function (e) {
                                trackCodeSnippetCodeDownload();
                                clipboardData.setData("Text", $(labelElems[scriptBlock.data(activeTabData)]).data('code'));
                                return false;
                            });
                            $(this).prepend(copyLink);
                        }
                    }
                });

                if ((window.parent) && (window.parent.Galleries)) {
                    window.parent.Galleries.project.resizeDesc();
                }

                    if (top.location == self.location) {
                         window.location.replace(window.location.href.replace('/description', ''));
                    }
            }

            function trackCodeSnippetCodeDownload() {
                if ((window.parent) && (window.parent.gTracker)) {
                    window.parent.gTracker.createActionEvent('Description', 'Download', 'Copy', 'CodeSnippet', null);
                }
            }
            
            function overrideAnchorLinksForFirefoxAndChrome(iframeId) {
                if(($.browser.mozilla && parseInt($.browser.version, 10) >= 2) || $.browser.webkit) {
                    var iframeOffset = $("#" + iframeId, window.parent.document).offset();
                    $("a").each(function () {
                        var link = $(this);
                        var href = link.attr("href");
                        if (href && href[0] == "#") {
                            var name = href.substring(1);
                            $(this).click(function () {
                                var nameElement = $("[name='" + name + "']");
                                var idElement = $("#" + name);
                                var element = null;
                                if (nameElement.length > 0) {
                                    element = nameElement;
                                } else if (idElement.length > 0) {
                                    element = idElement;
                                }

                                if (element) {
                                    var offset = element.offset();
                                    window.parent.scrollTo(offset.left, offset.top + iframeOffset.top);
                                }

                                return false;
                            });
                        }
                    });
                }
            }

            $(window).load(function(){
                initializePage();
                overrideAnchorLinksForFirefoxAndChrome("longdescIframe");

            });

        </script>
        <base target="_parent" />
    </head>
    <body>
        <div id="longDesc">
            
<p>This script will create claims-based web applications in SharePoint 2013.&nbsp; This script may also work in SharePoint 2010.&nbsp; This script will also set your object cache user accounts, as well as configuring your object cache accounts for your web
 applications.&nbsp; Significant conflict detection is included in this script, which should make creating web applications very simple.</p>
<p>&nbsp;</p>
<p>More details regarding this script can be found in my recent blog post:<br>
<a title="Creating Claims-Based Web Applications in SharePoint 2013" href="http://blogs.msdn.com/b/rcormier/archive/2012/10/30/creating-claims-based-web-applications-in-sharepoint-2013.aspx" target="_blank">Creating Claims-Based Web Applications in SharePoint
 2013</a></p>
<p>&nbsp;</p>
<p>Download the script for a fully commented version</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>PowerShell</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">powershell</span>
<pre class="hidden">$ver = $host | select version
if($Ver.version.major -gt 1) {$Host.Runspace.ThreadOptions = &quot;ReuseThread&quot;}
if(!(Get-PSSnapin Microsoft.SharePoint.PowerShell -ea 0))
{
Write-Progress -Activity &quot;Loading Modules&quot; -Status &quot;Loading Microsoft.SharePoint.PowerShell&quot;
Add-PSSnapin Microsoft.SharePoint.PowerShell
}
Write-Progress -Activity &quot;Creating Web Application&quot; -Status &quot;Setting Variables&quot;
$WebApplicationURL = &quot;http://Contoso.com&quot;
$WebApplicationName = &quot;Contoso SharePoint Site&quot;
$ContentDatabase = &quot;Contoso_ContentDB&quot;
$ApplicationPoolDisplayName = &quot;SharePoint App Pool&quot;
$ApplicationPoolIdentity = &quot;Contoso\SPAppPool&quot;
$ApplicationPoolPassword = &quot;Pass@word1&quot;
$PortalSuperReader = &quot;i:0#.w|Contoso\SuperReader&quot;
$PortalSuperUser = &quot;i:0#.w|Contoso\SuperUser&quot;
Write-Progress -Activity &quot;Creating Web Application&quot; -Status &quot;Loading Functions&quot;
Function CreateClaimsWebApp($WebApplicationName, $WebApplicationURL, $ContentDatabase, $HTTPPort)
{
    if($AppPoolUsed -eq $True)
    {
        Write-Progress -Activity &quot;Creating Web Application&quot; -Status &quot;Using Application Pool With Existing Web Applications&quot;
        Set-Variable -Name WebApp -Value (New-SPWebApplication -ApplicationPool $ApplicationPoolDisplayName -Name $WebApplicationName -url $WebApplicationURL -port $HTTPPort -DatabaseName $ContentDatabase -HostHeader $hostHeader -AuthenticationProvider (New-SPAuthenticationProvider)) -Scope Script
        Write-Progress -Activity &quot;Creating Web Application&quot; -Status &quot;Configuring Object Cache Accounts&quot;
        SetObjectCache
    }
    else
    {
        Write-Progress -Activity &quot;Creating Web Application&quot; -Status &quot;Using Application Pool With No Existing Web Applications&quot;
        Set-Variable -Name WebApp -Value (New-SPWebApplication -ApplicationPool $ApplicationPoolDisplayName -ApplicationPoolAccount $AppPoolManagedAccount.Username -Name $WebApplicationName -url $WebApplicationURL -port $HTTPPort -DatabaseName $ContentDatabase -HostHeader $hostHeader -AuthenticationProvider (New-SPAuthenticationProvider)) -Scope Script
        Write-Progress -Activity &quot;Creating Web Application&quot; -Status &quot;Configuring Object Cache Accounts&quot;
        SetObjectCache
    }
}
Function ValidateURL($WebApplicationURL)
{
    if(get-spwebapplication $WebApplicationURL -ErrorAction SilentlyContinue)
    {
        Write-Progress -Activity &quot;Creating Web Application&quot; -Status &quot;Aborting Process Due To URL Conflict&quot;
        Write-Host &quot;Aborting: Web Application $WebApplicationURL Already Exists&quot; -ForegroundColor Red
        sleep 5
        Set-Variable -Name CriticalError -Value $True
    }
    elseif($WebApplicationURL.StartsWith(&quot;http://&quot;))
        {
            Set-Variable HostHeader -Value ($WebApplicationURL.Substring(7)) -Scope Script
            Set-Variable -Name HTTPPort -Value &quot;80&quot; -Scope Script
        }
        elseif($WebApplicationURL.StartsWith(&quot;https://&quot;))
        {
            Set-Variable HostHeader -Value ($WebApplicationURL.Substring(8)) -Scope Script
            Set-Variable -Name HTTPPort -Value &quot;443&quot; -Scope Script
        }
}
Function ValidateAppPool($AppPoolName, $WebApplicationURL)
{
    $CurrentErrorActionPreference = $ErrorActionPreference
    $ErrorActionPreference = &quot;SilentlyContinue&quot;
    $TestAppPool = Get-WebAppPoolState $AppPoolName
    if(Get-SPServiceApplicationPool $AppPoolName)
    {
        $AppPools = Get-SPWebApplication | select ApplicationPool
        if($AppPools)
        {
            foreach($Pool in $AppPools)
            {
                [Array]$Poolchild = $Poolchild &#43;= ($Pool.ApplicationPool.DisplayName)
                if($Poolchild.Contains($ApplicationPoolDisplayName))
                {
                    Set-Variable -Name AppPoolUsed -Value $True -Scope Script
                }
                else
                {
                    Set-Variable -Name AppPoolUsed -Value $False -Scope Script
                }
            }
        }
        Set-Variable -Name AppPool -Value (Get-SPServiceApplicationPool $AppPoolName) -scope Script
        Set-Variable -Name AppPoolManagedAccount -Value (Get-SPManagedAccount | ? {$_.username -eq ($AppPool.ProcessAccountName)}) -scope Script
    }
    elseif($TestAppPool)
    {
        Write-Host &quot;Aborting: Application Pool $AppPoolName already exists on the server and is not a SharePoint Application Pool `n`rWeb Application `&quot;$WebApplicationURL`&quot; will not be created&quot; -ForegroundColor Red
        Set-Variable -Name CriticalError -Value $True
    }
    elseif(!($TestAppPool))
    {
        validateManagedAccount $ApplicationPoolIdentity
        if($ManagedAccountExists -eq $True)
        {
            Write-Host &quot;Creating New App Pool using Existing Managed Account&quot;
            Set-Variable -Name AppPoolManagedAccount -Value (Get-SPManagedAccount $ApplicationPoolIdentity | select username) -scope &quot;Script&quot;
            Set-Variable -Name AppPool -Value (New-SPServiceApplicationPool -Name $ApplicationPoolDisplayName -Account $ApplicationPoolIdentity) -scope &quot;Script&quot;
        }
        else
        {
            Write-Host &quot;Creating New Managed Account And App Pool&quot;
            $AppPoolCredentials = New-Object System.Management.Automation.PSCredential $ApplicationPoolIdentity, (ConvertTo-SecureString $ApplicationPoolPassword -AsPlainText -Force)
            Set-Variable -Name AppPoolManagedAccount -Value (New-SPManagedAccount -Credential $AppPoolCredentials) -scope &quot;Script&quot;
            Set-Variable -Name AppPool -Value (New-SPServiceApplicationPool -Name $ApplicationPoolDisplayName -Account (get-spmanagedaccount $ApplicationPoolIdentity)) -scope &quot;Script&quot;
        }
    }
    $ErrorActionPreference = $CurrentErrorActionPreference
}
Function ValidateManagedAccount($ApplicationPoolIdentity)
{
    if(Get-SPManagedAccount $ApplicationPoolIdentity -ErrorAction SilentlyContinue)
    {
        Set-Variable -Name ManagedAccountExists -Value $True -Scope Script
    }
    else
    {
        Set-Variable -Name ManagedAccountExists -Value $False -Scope Script
    }
}

Function ClearScriptVariables
{
    $CurrentErrorActionPreference = $ErrorActionPreference
    $ErrorActionPreference = &quot;SilentlyContinue&quot;
    Remove-Variable $CriticalError -ErrorAction SilentlyContinue
    $ErrorActionPreference = $CurrentErrorActionPreference
}
Function SetObjectCache
{
    $WebApp.Properties[&quot;portalsuperuseraccount&quot;] = $PortalSuperUser
    $WebApp.Properties[&quot;portalsuperreaderaccount&quot;] = $PortalSuperReader
    $SuperUserPolicy = $WebApp.Policies.Add($PortalSuperUser, &quot;Portal Super User Account&quot;)
    $SuperUserPolicy.PolicyRoleBindings.Add($WebApp.PolicyRoles.GetSpecialRole([Microsoft.SharePoint.Administration.SPPolicyRoleType]::FullControl))
    $SuperReaderPolicy = $WebApp.Policies.Add($PortalSuperReader, &quot;Portal Super Reader Account&quot;)
    $SuperReaderPolicy.PolicyRoleBindings.Add($WebApp.PolicyRoles.GetSpecialRole([Microsoft.SharePoint.Administration.SPPolicyRoleType]::FullRead))
    $WebApp.Update()
}
ClearScriptVariables
Write-Progress -Activity &quot;Creating Web Application&quot; -Status &quot;Validating Web Application URL Variables&quot;
ValidateURL $WebApplicationURL
Write-Progress -Activity &quot;Creating Web Application&quot; -Status &quot;Validating Application Pool Variables&quot;
ValidateAppPool $ApplicationPoolDisplayName $WebApplicationURL
if(!($CriticalError))
{
Write-Progress -Activity &quot;Creating Web Application&quot; -Status &quot;Creating Claims-Based Web Application&quot;
CreateClaimsWebApp $WebApplicationName $WebApplicationURL $ContentDatabase $HTTPPort
}
</pre>
<div class="preview">
<pre class="powershell"><span class="powerShell__variable">$ver</span>&nbsp;=&nbsp;<span class="powerShell__variable">$host</span>&nbsp;<span class="powerShell__operator">|</span>&nbsp;<span class="powerShell__alias">select</span>&nbsp;version&nbsp;
<span class="powerShell__keyword">if</span>(<span class="powerShell__variable">$Ver</span>.version.major&nbsp;<span class="powerShell__operator">-</span>gt&nbsp;1)&nbsp;{<span class="powerShell__variable">$Host</span>.Runspace.ThreadOptions&nbsp;=&nbsp;<span class="powerShell__string">&quot;ReuseThread&quot;</span>}&nbsp;
<span class="powerShell__keyword">if</span>(<span class="powerShell__operator">!</span>(<span class="powerShell__cmdlets">Get-PSSnapin</span>&nbsp;Microsoft.SharePoint.PowerShell&nbsp;<span class="powerShell__operator">-</span>ea&nbsp;0))&nbsp;
{&nbsp;
<span class="powerShell__cmdlets">Write-Progress</span>&nbsp;<span class="powerShell__operator">-</span>Activity&nbsp;<span class="powerShell__string">&quot;Loading&nbsp;Modules&quot;</span>&nbsp;<span class="powerShell__operator">-</span>Status&nbsp;<span class="powerShell__string">&quot;Loading&nbsp;Microsoft.SharePoint.PowerShell&quot;</span>&nbsp;
<span class="powerShell__cmdlets">Add-PSSnapin</span>&nbsp;Microsoft.SharePoint.PowerShell&nbsp;
}&nbsp;
<span class="powerShell__cmdlets">Write-Progress</span>&nbsp;<span class="powerShell__operator">-</span>Activity&nbsp;<span class="powerShell__string">&quot;Creating&nbsp;Web&nbsp;Application&quot;</span>&nbsp;<span class="powerShell__operator">-</span>Status&nbsp;<span class="powerShell__string">&quot;Setting&nbsp;Variables&quot;</span>&nbsp;
<span class="powerShell__variable">$WebApplicationURL</span>&nbsp;=&nbsp;<span class="powerShell__string">&quot;http://Contoso.com&quot;</span>&nbsp;
<span class="powerShell__variable">$WebApplicationName</span>&nbsp;=&nbsp;<span class="powerShell__string">&quot;Contoso&nbsp;SharePoint&nbsp;Site&quot;</span>&nbsp;
<span class="powerShell__variable">$ContentDatabase</span>&nbsp;=&nbsp;<span class="powerShell__string">&quot;Contoso_ContentDB&quot;</span>&nbsp;
<span class="powerShell__variable">$ApplicationPoolDisplayName</span>&nbsp;=&nbsp;<span class="powerShell__string">&quot;SharePoint&nbsp;App&nbsp;Pool&quot;</span>&nbsp;
<span class="powerShell__variable">$ApplicationPoolIdentity</span>&nbsp;=&nbsp;<span class="powerShell__string">&quot;Contoso\SPAppPool&quot;</span>&nbsp;
<span class="powerShell__variable">$ApplicationPoolPassword</span>&nbsp;=&nbsp;<span class="powerShell__string">&quot;Pass@word1&quot;</span>&nbsp;
<span class="powerShell__variable">$PortalSuperReader</span>&nbsp;=&nbsp;<span class="powerShell__string">&quot;i:0#.w|Contoso\SuperReader&quot;</span>&nbsp;
<span class="powerShell__variable">$PortalSuperUser</span>&nbsp;=&nbsp;<span class="powerShell__string">&quot;i:0#.w|Contoso\SuperUser&quot;</span>&nbsp;
<span class="powerShell__cmdlets">Write-Progress</span>&nbsp;<span class="powerShell__operator">-</span>Activity&nbsp;<span class="powerShell__string">&quot;Creating&nbsp;Web&nbsp;Application&quot;</span>&nbsp;<span class="powerShell__operator">-</span>Status&nbsp;<span class="powerShell__string">&quot;Loading&nbsp;Functions&quot;</span>&nbsp;
<span class="powerShell__keyword">Function</span>&nbsp;CreateClaimsWebApp(<span class="powerShell__variable">$WebApplicationName</span>,&nbsp;<span class="powerShell__variable">$WebApplicationURL</span>,&nbsp;<span class="powerShell__variable">$ContentDatabase</span>,&nbsp;<span class="powerShell__variable">$HTTPPort</span>)&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">if</span>(<span class="powerShell__variable">$AppPoolUsed</span>&nbsp;<span class="powerShell__operator">-</span>eq&nbsp;<span class="powerShell__variable">$True</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__cmdlets">Write-Progress</span>&nbsp;<span class="powerShell__operator">-</span>Activity&nbsp;<span class="powerShell__string">&quot;Creating&nbsp;Web&nbsp;Application&quot;</span>&nbsp;<span class="powerShell__operator">-</span>Status&nbsp;<span class="powerShell__string">&quot;Using&nbsp;Application&nbsp;Pool&nbsp;With&nbsp;Existing&nbsp;Web&nbsp;Applications&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;WebApp&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;(New<span class="powerShell__operator">-</span>SPWebApplication&nbsp;<span class="powerShell__operator">-</span>ApplicationPool&nbsp;<span class="powerShell__variable">$ApplicationPoolDisplayName</span>&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;<span class="powerShell__variable">$WebApplicationName</span>&nbsp;<span class="powerShell__operator">-</span>url&nbsp;<span class="powerShell__variable">$WebApplicationURL</span>&nbsp;<span class="powerShell__operator">-</span>port&nbsp;<span class="powerShell__variable">$HTTPPort</span>&nbsp;<span class="powerShell__operator">-</span>DatabaseName&nbsp;<span class="powerShell__variable">$ContentDatabase</span>&nbsp;<span class="powerShell__operator">-</span>HostHeader&nbsp;<span class="powerShell__variable">$hostHeader</span>&nbsp;<span class="powerShell__operator">-</span>AuthenticationProvider&nbsp;(New<span class="powerShell__operator">-</span>SPAuthenticationProvider))&nbsp;<span class="powerShell__operator">-</span>Scope&nbsp;Script&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__cmdlets">Write-Progress</span>&nbsp;<span class="powerShell__operator">-</span>Activity&nbsp;<span class="powerShell__string">&quot;Creating&nbsp;Web&nbsp;Application&quot;</span>&nbsp;<span class="powerShell__operator">-</span>Status&nbsp;<span class="powerShell__string">&quot;Configuring&nbsp;Object&nbsp;Cache&nbsp;Accounts&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetObjectCache&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">else</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__cmdlets">Write-Progress</span>&nbsp;<span class="powerShell__operator">-</span>Activity&nbsp;<span class="powerShell__string">&quot;Creating&nbsp;Web&nbsp;Application&quot;</span>&nbsp;<span class="powerShell__operator">-</span>Status&nbsp;<span class="powerShell__string">&quot;Using&nbsp;Application&nbsp;Pool&nbsp;With&nbsp;No&nbsp;Existing&nbsp;Web&nbsp;Applications&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;WebApp&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;(New<span class="powerShell__operator">-</span>SPWebApplication&nbsp;<span class="powerShell__operator">-</span>ApplicationPool&nbsp;<span class="powerShell__variable">$ApplicationPoolDisplayName</span>&nbsp;<span class="powerShell__operator">-</span>ApplicationPoolAccount&nbsp;<span class="powerShell__variable">$AppPoolManagedAccount</span>.Username&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;<span class="powerShell__variable">$WebApplicationName</span>&nbsp;<span class="powerShell__operator">-</span>url&nbsp;<span class="powerShell__variable">$WebApplicationURL</span>&nbsp;<span class="powerShell__operator">-</span>port&nbsp;<span class="powerShell__variable">$HTTPPort</span>&nbsp;<span class="powerShell__operator">-</span>DatabaseName&nbsp;<span class="powerShell__variable">$ContentDatabase</span>&nbsp;<span class="powerShell__operator">-</span>HostHeader&nbsp;<span class="powerShell__variable">$hostHeader</span>&nbsp;<span class="powerShell__operator">-</span>AuthenticationProvider&nbsp;(New<span class="powerShell__operator">-</span>SPAuthenticationProvider))&nbsp;<span class="powerShell__operator">-</span>Scope&nbsp;Script&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__cmdlets">Write-Progress</span>&nbsp;<span class="powerShell__operator">-</span>Activity&nbsp;<span class="powerShell__string">&quot;Creating&nbsp;Web&nbsp;Application&quot;</span>&nbsp;<span class="powerShell__operator">-</span>Status&nbsp;<span class="powerShell__string">&quot;Configuring&nbsp;Object&nbsp;Cache&nbsp;Accounts&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetObjectCache&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
}&nbsp;
<span class="powerShell__keyword">Function</span>&nbsp;ValidateURL(<span class="powerShell__variable">$WebApplicationURL</span>)&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">if</span>(get<span class="powerShell__operator">-</span>spwebapplication&nbsp;<span class="powerShell__variable">$WebApplicationURL</span>&nbsp;<span class="powerShell__operator">-</span>ErrorAction&nbsp;SilentlyContinue)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__cmdlets">Write-Progress</span>&nbsp;<span class="powerShell__operator">-</span>Activity&nbsp;<span class="powerShell__string">&quot;Creating&nbsp;Web&nbsp;Application&quot;</span>&nbsp;<span class="powerShell__operator">-</span>Status&nbsp;<span class="powerShell__string">&quot;Aborting&nbsp;Process&nbsp;Due&nbsp;To&nbsp;URL&nbsp;Conflict&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write<span class="powerShell__operator">-</span>Host&nbsp;<span class="powerShell__string">&quot;Aborting:&nbsp;Web&nbsp;Application&nbsp;$WebApplicationURL&nbsp;Already&nbsp;Exists&quot;</span>&nbsp;<span class="powerShell__operator">-</span>ForegroundColor&nbsp;Red&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__alias">sleep</span>&nbsp;5&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;CriticalError&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;<span class="powerShell__variable">$True</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">elseif</span>(<span class="powerShell__variable">$WebApplicationURL</span>.StartsWith(<span class="powerShell__string">&quot;http://&quot;</span>))&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;HostHeader&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;(<span class="powerShell__variable">$WebApplicationURL</span>.Substring(7))&nbsp;<span class="powerShell__operator">-</span>Scope&nbsp;Script&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;HTTPPort&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;<span class="powerShell__string">&quot;80&quot;</span>&nbsp;<span class="powerShell__operator">-</span>Scope&nbsp;Script&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">elseif</span>(<span class="powerShell__variable">$WebApplicationURL</span>.StartsWith(<span class="powerShell__string">&quot;https://&quot;</span>))&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;HostHeader&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;(<span class="powerShell__variable">$WebApplicationURL</span>.Substring(8))&nbsp;<span class="powerShell__operator">-</span>Scope&nbsp;Script&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;HTTPPort&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;<span class="powerShell__string">&quot;443&quot;</span>&nbsp;<span class="powerShell__operator">-</span>Scope&nbsp;Script&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
}&nbsp;
<span class="powerShell__keyword">Function</span>&nbsp;ValidateAppPool(<span class="powerShell__variable">$AppPoolName</span>,&nbsp;<span class="powerShell__variable">$WebApplicationURL</span>)&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$CurrentErrorActionPreference</span>&nbsp;=&nbsp;<span class="powerShell__variable">$ErrorActionPreference</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$ErrorActionPreference</span>&nbsp;=&nbsp;<span class="powerShell__string">&quot;SilentlyContinue&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$TestAppPool</span>&nbsp;=&nbsp;Get<span class="powerShell__operator">-</span>WebAppPoolState&nbsp;<span class="powerShell__variable">$AppPoolName</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">if</span>(Get<span class="powerShell__operator">-</span>SPServiceApplicationPool&nbsp;<span class="powerShell__variable">$AppPoolName</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$AppPools</span>&nbsp;=&nbsp;Get<span class="powerShell__operator">-</span>SPWebApplication&nbsp;<span class="powerShell__operator">|</span>&nbsp;<span class="powerShell__alias">select</span>&nbsp;ApplicationPool&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">if</span>(<span class="powerShell__variable">$AppPools</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">foreach</span>(<span class="powerShell__variable">$Pool</span>&nbsp;<span class="powerShell__keyword">in</span>&nbsp;<span class="powerShell__variable">$AppPools</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Array]<span class="powerShell__variable">$Poolchild</span>&nbsp;=&nbsp;<span class="powerShell__variable">$Poolchild</span>&nbsp;<span class="powerShell__operator">&#43;</span>=&nbsp;(<span class="powerShell__variable">$Pool</span>.ApplicationPool.DisplayName)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">if</span>(<span class="powerShell__variable">$Poolchild</span>.Contains(<span class="powerShell__variable">$ApplicationPoolDisplayName</span>))&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;AppPoolUsed&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;<span class="powerShell__variable">$True</span>&nbsp;<span class="powerShell__operator">-</span>Scope&nbsp;Script&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">else</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;AppPoolUsed&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;<span class="powerShell__variable">$False</span>&nbsp;<span class="powerShell__operator">-</span>Scope&nbsp;Script&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;AppPool&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;(Get<span class="powerShell__operator">-</span>SPServiceApplicationPool&nbsp;<span class="powerShell__variable">$AppPoolName</span>)&nbsp;<span class="powerShell__operator">-</span>scope&nbsp;Script&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;AppPoolManagedAccount&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;(Get<span class="powerShell__operator">-</span>SPManagedAccount&nbsp;<span class="powerShell__operator">|</span>&nbsp;?&nbsp;{<span class="powerShell__variable">$_</span>.username&nbsp;<span class="powerShell__operator">-</span>eq&nbsp;(<span class="powerShell__variable">$AppPool</span>.ProcessAccountName)})&nbsp;<span class="powerShell__operator">-</span>scope&nbsp;Script&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">elseif</span>(<span class="powerShell__variable">$TestAppPool</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write<span class="powerShell__operator">-</span>Host&nbsp;<span class="powerShell__string">&quot;Aborting:&nbsp;Application&nbsp;Pool&nbsp;$AppPoolName&nbsp;already&nbsp;exists&nbsp;on&nbsp;the&nbsp;server&nbsp;and&nbsp;is&nbsp;not&nbsp;a&nbsp;SharePoint&nbsp;Application&nbsp;Pool&nbsp;`n`rWeb&nbsp;Application&nbsp;`&quot;</span><span class="powerShell__variable">$WebApplicationURL</span>`<span class="powerShell__string">&quot;&nbsp;will&nbsp;not&nbsp;be&nbsp;created&quot;</span>&nbsp;<span class="powerShell__operator">-</span>ForegroundColor&nbsp;Red&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;CriticalError&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;<span class="powerShell__variable">$True</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">elseif</span>(<span class="powerShell__operator">!</span>(<span class="powerShell__variable">$TestAppPool</span>))&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;validateManagedAccount&nbsp;<span class="powerShell__variable">$ApplicationPoolIdentity</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">if</span>(<span class="powerShell__variable">$ManagedAccountExists</span>&nbsp;<span class="powerShell__operator">-</span>eq&nbsp;<span class="powerShell__variable">$True</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write<span class="powerShell__operator">-</span>Host&nbsp;<span class="powerShell__string">&quot;Creating&nbsp;New&nbsp;App&nbsp;Pool&nbsp;using&nbsp;Existing&nbsp;Managed&nbsp;Account&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;AppPoolManagedAccount&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;(Get<span class="powerShell__operator">-</span>SPManagedAccount&nbsp;<span class="powerShell__variable">$ApplicationPoolIdentity</span>&nbsp;<span class="powerShell__operator">|</span>&nbsp;<span class="powerShell__alias">select</span>&nbsp;username)&nbsp;<span class="powerShell__operator">-</span>scope&nbsp;<span class="powerShell__string">&quot;Script&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;AppPool&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;(New<span class="powerShell__operator">-</span>SPServiceApplicationPool&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;<span class="powerShell__variable">$ApplicationPoolDisplayName</span>&nbsp;<span class="powerShell__operator">-</span>Account&nbsp;<span class="powerShell__variable">$ApplicationPoolIdentity</span>)&nbsp;<span class="powerShell__operator">-</span>scope&nbsp;<span class="powerShell__string">&quot;Script&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">else</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write<span class="powerShell__operator">-</span>Host&nbsp;<span class="powerShell__string">&quot;Creating&nbsp;New&nbsp;Managed&nbsp;Account&nbsp;And&nbsp;App&nbsp;Pool&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$AppPoolCredentials</span>&nbsp;=&nbsp;<span class="powerShell__cmdlets">New-Object</span>&nbsp;System.Management.Automation.PSCredential&nbsp;<span class="powerShell__variable">$ApplicationPoolIdentity</span>,&nbsp;(<span class="powerShell__cmdlets">ConvertTo-SecureString</span>&nbsp;<span class="powerShell__variable">$ApplicationPoolPassword</span>&nbsp;<span class="powerShell__operator">-</span>AsPlainText&nbsp;<span class="powerShell__operator">-</span>Force)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;AppPoolManagedAccount&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;(New<span class="powerShell__operator">-</span>SPManagedAccount&nbsp;<span class="powerShell__operator">-</span>Credential&nbsp;<span class="powerShell__variable">$AppPoolCredentials</span>)&nbsp;<span class="powerShell__operator">-</span>scope&nbsp;<span class="powerShell__string">&quot;Script&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;AppPool&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;(New<span class="powerShell__operator">-</span>SPServiceApplicationPool&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;<span class="powerShell__variable">$ApplicationPoolDisplayName</span>&nbsp;<span class="powerShell__operator">-</span>Account&nbsp;(get<span class="powerShell__operator">-</span>spmanagedaccount&nbsp;<span class="powerShell__variable">$ApplicationPoolIdentity</span>))&nbsp;<span class="powerShell__operator">-</span>scope&nbsp;<span class="powerShell__string">&quot;Script&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$ErrorActionPreference</span>&nbsp;=&nbsp;<span class="powerShell__variable">$CurrentErrorActionPreference</span>&nbsp;
}&nbsp;
<span class="powerShell__keyword">Function</span>&nbsp;ValidateManagedAccount(<span class="powerShell__variable">$ApplicationPoolIdentity</span>)&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">if</span>(Get<span class="powerShell__operator">-</span>SPManagedAccount&nbsp;<span class="powerShell__variable">$ApplicationPoolIdentity</span>&nbsp;<span class="powerShell__operator">-</span>ErrorAction&nbsp;SilentlyContinue)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;ManagedAccountExists&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;<span class="powerShell__variable">$True</span>&nbsp;<span class="powerShell__operator">-</span>Scope&nbsp;Script&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">else</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set<span class="powerShell__operator">-</span>Variable&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;ManagedAccountExists&nbsp;<span class="powerShell__operator">-</span>Value&nbsp;<span class="powerShell__variable">$False</span>&nbsp;<span class="powerShell__operator">-</span>Scope&nbsp;Script&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
}&nbsp;
&nbsp;
<span class="powerShell__keyword">Function</span>&nbsp;ClearScriptVariables&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$CurrentErrorActionPreference</span>&nbsp;=&nbsp;<span class="powerShell__variable">$ErrorActionPreference</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$ErrorActionPreference</span>&nbsp;=&nbsp;<span class="powerShell__string">&quot;SilentlyContinue&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__cmdlets">Remove-Variable</span>&nbsp;<span class="powerShell__variable">$CriticalError</span>&nbsp;<span class="powerShell__operator">-</span>ErrorAction&nbsp;SilentlyContinue&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$ErrorActionPreference</span>&nbsp;=&nbsp;<span class="powerShell__variable">$CurrentErrorActionPreference</span>&nbsp;
}&nbsp;
<span class="powerShell__keyword">Function</span>&nbsp;SetObjectCache&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$WebApp</span>.Properties[<span class="powerShell__string">&quot;portalsuperuseraccount&quot;</span>]&nbsp;=&nbsp;<span class="powerShell__variable">$PortalSuperUser</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$WebApp</span>.Properties[<span class="powerShell__string">&quot;portalsuperreaderaccount&quot;</span>]&nbsp;=&nbsp;<span class="powerShell__variable">$PortalSuperReader</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$SuperUserPolicy</span>&nbsp;=&nbsp;<span class="powerShell__variable">$WebApp</span>.Policies.Add(<span class="powerShell__variable">$PortalSuperUser</span>,&nbsp;<span class="powerShell__string">&quot;Portal&nbsp;Super&nbsp;User&nbsp;Account&quot;</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$SuperUserPolicy</span>.PolicyRoleBindings.Add(<span class="powerShell__variable">$WebApp</span>.PolicyRoles.GetSpecialRole([Microsoft.SharePoint.Administration.SPPolicyRoleType]::FullControl))&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$SuperReaderPolicy</span>&nbsp;=&nbsp;<span class="powerShell__variable">$WebApp</span>.Policies.Add(<span class="powerShell__variable">$PortalSuperReader</span>,&nbsp;<span class="powerShell__string">&quot;Portal&nbsp;Super&nbsp;Reader&nbsp;Account&quot;</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$SuperReaderPolicy</span>.PolicyRoleBindings.Add(<span class="powerShell__variable">$WebApp</span>.PolicyRoles.GetSpecialRole([Microsoft.SharePoint.Administration.SPPolicyRoleType]::FullRead))&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$WebApp</span>.Update()&nbsp;
}&nbsp;
ClearScriptVariables&nbsp;
<span class="powerShell__cmdlets">Write-Progress</span>&nbsp;<span class="powerShell__operator">-</span>Activity&nbsp;<span class="powerShell__string">&quot;Creating&nbsp;Web&nbsp;Application&quot;</span>&nbsp;<span class="powerShell__operator">-</span>Status&nbsp;<span class="powerShell__string">&quot;Validating&nbsp;Web&nbsp;Application&nbsp;URL&nbsp;Variables&quot;</span>&nbsp;
ValidateURL&nbsp;<span class="powerShell__variable">$WebApplicationURL</span>&nbsp;
<span class="powerShell__cmdlets">Write-Progress</span>&nbsp;<span class="powerShell__operator">-</span>Activity&nbsp;<span class="powerShell__string">&quot;Creating&nbsp;Web&nbsp;Application&quot;</span>&nbsp;<span class="powerShell__operator">-</span>Status&nbsp;<span class="powerShell__string">&quot;Validating&nbsp;Application&nbsp;Pool&nbsp;Variables&quot;</span>&nbsp;
ValidateAppPool&nbsp;<span class="powerShell__variable">$ApplicationPoolDisplayName</span>&nbsp;<span class="powerShell__variable">$WebApplicationURL</span>&nbsp;
<span class="powerShell__keyword">if</span>(<span class="powerShell__operator">!</span>(<span class="powerShell__variable">$CriticalError</span>))&nbsp;
{&nbsp;
<span class="powerShell__cmdlets">Write-Progress</span>&nbsp;<span class="powerShell__operator">-</span>Activity&nbsp;<span class="powerShell__string">&quot;Creating&nbsp;Web&nbsp;Application&quot;</span>&nbsp;<span class="powerShell__operator">-</span>Status&nbsp;<span class="powerShell__string">&quot;Creating&nbsp;Claims-Based&nbsp;Web&nbsp;Application&quot;</span>&nbsp;
CreateClaimsWebApp&nbsp;<span class="powerShell__variable">$WebApplicationName</span>&nbsp;<span class="powerShell__variable">$WebApplicationURL</span>&nbsp;<span class="powerShell__variable">$ContentDatabase</span>&nbsp;<span class="powerShell__variable">$HTTPPort</span>&nbsp;
}&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p>&nbsp;</p>

        </div>
    </body>
</html>