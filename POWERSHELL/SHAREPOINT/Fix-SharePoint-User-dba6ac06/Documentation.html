<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head>
        <title>Fix SharePoint User Profile Synchronisation</title>        
        <meta name="description" content="If you&#39;re a SharePoint IT pro, no doubt you&#39;ve seen the issue with the User Profile Synchronisation Service failing to start many times. This script automatically repairs the sync service in both SharePoint 2010 and SharePoint 2013." />
        <link href="https://i1.code.msdn.s-msft.com/RequestReduceContent/c82dc8ab865be0fb7316b2e09ac97654-bafb67d64bd55a2b1fd123070a82b424-RequestReducedStyle.css" rel="Stylesheet" type="text/css" />        
        <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.6.1.min.js" type="text/javascript" ></script>
        <script src="https://i1.code.msdn.s-msft.com/RequestReduceContent/a12c72272a8fe142a00d8aae0ff5525e-cf9957f54e208c66abb738158989dd84-RequestReducedScript.js" type="text/javascript" ></script>                        <script type="text/javascript">
            function initializePage() {
                var activeTabData = 'activeTab';
                var otherTabClass = 'otherTab';
                var hiddenPreClass = 'hidden';
                $("a[href^=#]").attr("target","_self");
                $("div.scriptcode").each(function (i) {
                    var scriptBlock = $(this);
                    scriptBlock.trackCopy(trackCodeSnippetCodeDownload);
                    var labelElems = scriptBlock.find("div.title > span");
                    if (labelElems.length == 0) {
                        labelElems = scriptBlock.find("div.title");
                    }
                    var languageSpans = scriptBlock.find("span.hidden");
                    var pres = scriptBlock.find("pre");
                    if (languageSpans.length > 0 && pres.length > 1) {
                        labelElems.each(function(index, elem) {
                            var codePre = $(pres[index]);
                            var labelSpan = $(elem);
                            var languageSpan = $(languageSpans[index]);
                            labelSpan.data('code', codePre.text().replace(/(\r(\n)?)|((\r)?\n)/ig, '\r\n'));
                            codePre.removeClass(hiddenPreClass);  
                            codePre.addClass(languageSpan.text().replace(/^\s+|\s+$/g,""));
                            codePre.chili();
                            languageSpan.remove();
                        });

                        pres = scriptBlock.find("pre");
                        labelElems.each(function(index, elem) {
                            var codePre = $(pres[index]);
                            var labelSpan = $(elem);
                            if (index == 0) {
                                scriptBlock.data(activeTabData, 0);
                            }
                            else {
                                labelSpan.addClass(otherTabClass);
                                codePre.addClass(hiddenPreClass);  
                            }
                            labelSpan.click(function (e) {
                                var activeTab = scriptBlock.data(activeTabData);
                                $(labelElems[activeTab]).addClass(otherTabClass);   
                                $(pres[activeTab]).addClass(hiddenPreClass);   
                                        
                                codePre.removeClass(hiddenPreClass);    
                                labelSpan.removeClass(otherTabClass);
                                scriptBlock.data(activeTabData, index);

                                if( window.parent.Galleries ) {
                                    window.parent.Galleries.project.resizeDesc();
                                }
                            });
                        });

                        var preview = scriptBlock.find('div.preview');
                        if (preview.length == 0) {
                            preview = $(pres[pres.length - 1]);
                        }
                        preview.remove();

                        if (window.clipboardData && clipboardData.setData) {
                            var copyLink = $("<a href='#' class='copyCode'>Copy code</a>");
                            copyLink.click(function (e) {
                                trackCodeSnippetCodeDownload();
                                clipboardData.setData("Text", $(labelElems[scriptBlock.data(activeTabData)]).data('code'));
                                return false;
                            });
                            $(this).prepend(copyLink);
                        }
                    }
                });

                if ((window.parent) && (window.parent.Galleries)) {
                    window.parent.Galleries.project.resizeDesc();
                }

                    if (top.location == self.location) {
                         window.location.replace(window.location.href.replace('/description', ''));
                    }
            }

            function trackCodeSnippetCodeDownload() {
                if ((window.parent) && (window.parent.gTracker)) {
                    window.parent.gTracker.createActionEvent('Description', 'Download', 'Copy', 'CodeSnippet', null);
                }
            }
            
            function overrideAnchorLinksForFirefoxAndChrome(iframeId) {
                if(($.browser.mozilla && parseInt($.browser.version, 10) >= 2) || $.browser.webkit) {
                    var iframeOffset = $("#" + iframeId, window.parent.document).offset();
                    $("a").each(function () {
                        var link = $(this);
                        var href = link.attr("href");
                        if (href && href[0] == "#") {
                            var name = href.substring(1);
                            $(this).click(function () {
                                var nameElement = $("[name='" + name + "']");
                                var idElement = $("#" + name);
                                var element = null;
                                if (nameElement.length > 0) {
                                    element = nameElement;
                                } else if (idElement.length > 0) {
                                    element = idElement;
                                }

                                if (element) {
                                    var offset = element.offset();
                                    window.parent.scrollTo(offset.left, offset.top + iframeOffset.top);
                                }

                                return false;
                            });
                        }
                    });
                }
            }

            $(window).load(function(){
                initializePage();
                overrideAnchorLinksForFirefoxAndChrome("longdescIframe");

            });

        </script>
        <base target="_parent" />
    </head>
    <body>
        <div id="longDesc">
            
<p>If you're a SharePoint IT pro, no doubt you've seen the issue with the User Profile Synchronisation Service failing to start many times. This script automatically repairs the sync service in both SharePoint 2010 and SharePoint 2013.&nbsp;</p>
<p>You can import the function file into your current session like this:</p>
<p>. .\Fix-SPUserProfileSync.ps1</p>
<p>You can see how to use it like this:</p>
<p>Get-Help Fix-SPUserProfileSync -Examples</p>
<p>&nbsp;</p>
<p>Caveats: the account running the script should have DBcreator and SecurityAdmin rights on the SQL server, as well as local administrator credentials on the SharePoint server. You'll also need to be able to invoke a remote PowerShell session on your SQL server.
 You will also need to recreate your synchronisation connections afterward, as this script reprovisions the service database.</p>
<p>Attribution: Inspiration for some of the code taken from the excellent AutoSPInstaller project: http://autospinstaller.codeplex.com</p>
<p>&nbsp;</p>
<p>UPDATES:&nbsp;</p>
<p>V1.1 - Fixed loop for adding SQL modules</p>
<p>&nbsp;</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>PowerShell</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">powershell</span>
<pre class="hidden">Add-PSSnapin Microsoft.SharePoint.PowerShell -ErrorAction SilentlyContinue

# ====================================================================================
# Func: Get-AdministratorsGroup
# Desc: Returns the actual (localized) name of the built-in Administrators group
# From: Taken from the AutoSPInstaller project: http://autospinstaller.codeplex.com
# ====================================================================================

Function Get-AdministratorsGroup
{
    If(!$builtinAdminGroup)
    {
        $builtinAdminGroup = (Get-WmiObject -Class Win32_Group -computername $env:COMPUTERNAME -Filter &quot;SID='S-1-5-32-544' AND LocalAccount='True'&quot; -errorAction &quot;Stop&quot;).Name
    }
    Return $builtinAdminGroup
}

# ====================================================================================
# ScriptBlock: AlterDB
# Description: PowerShell script block passed to the SQL server
# ====================================================================================

[ScriptBlock] $global:AlterDB = {

    param ([string] $DBName,[string] $LoginName)

    # Create our SQL query to fix db permissions
    [string] $dbCommand = &quot;ALTER AUTHORIZATION ON DATABASE::[$DBname] TO [$LoginName];&quot;

    # Attempt to get SQL cmdlets
    $SQLSnapins = Get-PSSnapin -registered | Where-Object {$_.Name -like &quot;SqlServer*&quot;}
    $SQLModules = Get-Module | Where-Object {$_.Name -like &quot;SQL*&quot;}
    $SQLcmdlets = $false

    # Check to see if a snapin for the SQL cmdlets exists (versions prior to SQL 2012)
    if($SQLSnapins -ne $null)
    {
        foreach($Snapin in $SQLSnapins)
        {
            Add-PSSnapin $Snapin | Out-Null
        }
        $SQLcmdlets = $true
    }

    # If no snapin, check for SQL module (SQL 2012&#43;)
    elseif($SQLModules -ne $null)
    {
        foreach($Module in $SQLModules)
        {
            Import-Module SQLPS | Out-Null
        } 
        $SQLcmdlets = $true            
    }

    # Display warning if no SQL cmdlets available
    else
    {
        Write-Host &quot;No SQL cmdlets found!&quot; -ForegroundColor Yellow
    }

    # If SQL cmdlets available, execute our query
    if($SQLcmdlets -eq $true)
    {
        Invoke-SqlCmd -Query $dbCommand
    }
}

&lt;#
.SYNOPSIS
Reprovisions the User Profile Synchronization Service	

.DESCRIPTION
This function fixes the SharePoint user profile synchronization service not starting by reprovisioning the User Profile Synchronization Service. DBcreator and SecurityAdmin access to the SharePoint SQL server are required, as well as local administrator on the SharePoint application server. You'll also need to be able to invoke a remote PowerShell session on the SQL server. In addition, you will have to recreate your synchronization connections afterward (I hope to automate this in a future release of this script).

.EXAMPLE
Fix-SPUserProfileSync -FarmAdmin &quot;DOMAIN\SP_farm&quot; -FarmPassword &quot;FARM_password&quot; -DBServer &quot;DBServerName&quot;

This command takes three required parameters and resets the synchronisation database. &quot;DBServerName&quot; can be an alias or the actual SQL server name.

.NOTES
NAME: Fix-SPUserProfileSync
AUTHOR: Wes Kroesbergen
CAVEATS: DBcreator and SecurityAdmin access to the SharePoint SQL server are required, as well as local administrator on the SharePoint application server. You'll also need to be able to invoke a remote PowerShell session on the SQL server. In addition, you will have to recreate your synchronization connections afterward (I hope to automate this in a future release of this script).

.LINK
http://www.kroesbergens.com
#&gt;

Function Fix-SPUserProfileSync
{
    Param([Parameter(Position=0,Mandatory=$true)][string] $FarmAdmin,
        [Parameter(Position=1,Mandatory=$true)][string] $FarmPassword,
        [Parameter(Position=2,Mandatory=$true)][string] $DBServer)

    $FarmPassword = ConvertTo-SecureString $FarmPassword -AsPlainText -Force    
    $farmAcctDomain,$farmAcctUser = $farmAdmin -Split &quot;\\&quot;
    $builtinAdminGroup = Get-AdministratorsGroup

    # Elevate privileges if necessary
    Try
    {        
        ([ADSI]&quot;WinNT://$env:COMPUTERNAME/$builtinAdminGroup,group&quot;).Add(&quot;WinNT://$farmAcctDomain/$farmAcctUser&quot;)
        If (-not $?) {Throw}
        # Restart the SPTimerV4 service if it's running, so it will pick up the new credential
        If ((Get-Service -Name SPTimerV4).Status -eq &quot;Running&quot;)
        {
            Write-Host -ForegroundColor White &quot; - Restarting SharePoint Timer Service...&quot;
            Restart-Service SPTimerV4
        }
    }
    Catch {Write-Host -ForegroundColor White &quot; - $FarmAdmin is already a member of `&quot;$builtinAdminGroup`&quot;.&quot;}

    # Stop the Timer Service
    Stop-Service sptimerv4

    # Get the Sync DB and clear the data
    $SyncDB=Get-SPDatabase | Where-Object {$_.Type -eq &quot;Microsoft.Office.Server.Administration.SynchronizationDatabase&quot;}
    $SyncDB.Unprovision()
    $SyncDB.Status='Offline'

    # Reset the Sync info in the User Profile Application
    $UPA=Get-SPServiceApplication | Where-Object {$_.TypeName -match &quot;User Profile Service Application&quot;}
    $UPA.ResetSynchronizationMachine()
    $UPA.ResetSynchronizationDatabase()

    # Reprovision the Sync DB
    $SyncDB.Provision()

    $UPSinstance = Get-SPServiceInstance | Where-Object {$_.TypeName -match &quot;User Profile Synchronization Service&quot; }
    $UPA.SetSynchronizationMachine($env:COMPUTERNAME, $UPSinstance.ID, $FarmAdmin, $FarmPassword)
    Start-SPServiceInstance -Identity $UPSinstance.ID 

    # Before we try to connect remotely, let's confirm DBServer is not an alias
    $AliasPath = &quot;HKLM:\Software\Microsoft\MSSQLServer\Client\ConnectTo\&quot;
    $Item = Get-ItemProperty -Path $AliasPath -Name $DBServer
    if ((test-path -path $AliasPath) -eq $True)
    {
        write-host &quot;Alias exists!&quot;

        # If object exists, we parse the definitions and retrieve the one with a TCP alias value
        $AliasProperties = ($Item | Get-Member | Where-Object {$_.Definition -like &quot;*DBMSSOCN*&quot;}).Definition.Split(&quot;,&quot;)
        $DBServer = $AliasProperties[1]
        Write-Host &quot;Actual server name is $DBServer!&quot; -ForegroundColor Yellow
    }

    # Make sure the farm account has DBO rights to Sync DB
    Invoke-Command -ComputerName $DBServer -ScriptBlock $AlterDB -ArgumentList $SyncDB,$FarmAdmin

    # Start the Timer Service
    Start-Service sptimerv4

    # Remove farm account from local admin
    Write-Host -ForegroundColor White &quot; - Removing $FarmAdmin from local group `&quot;$builtinAdminGroup`&quot;...&quot;
        
    try
    {
        ([ADSI]&quot;WinNT://$env:COMPUTERNAME/$builtinAdminGroup,group&quot;).Remove(&quot;WinNT://$farmAcctDomain/$farmAcctUser&quot;)
        If (-not $?) {throw}
    }
    catch {Write-Host -ForegroundColor White &quot; - $FarmAdmin already removed from `&quot;$builtinAdminGroup.`&quot;&quot;}

    # Restart SPTimerV4 so it can now run under non-local Admin privileges and avoid Health Analyzer warning
    Write-Host -ForegroundColor White &quot; - Starting SharePoint Timer Service...&quot;

    Restart-Service SPTimerV4
}</pre>
<div class="preview">
<pre class="powershell"><span class="powerShell__cmdlets">Add-PSSnapin</span>&nbsp;Microsoft.SharePoint.PowerShell&nbsp;<span class="powerShell__operator">-</span>ErrorAction&nbsp;SilentlyContinue&nbsp;
&nbsp;
<span class="powerShell__com">#&nbsp;====================================================================================</span>&nbsp;
<span class="powerShell__com">#&nbsp;Func:&nbsp;Get-AdministratorsGroup</span>&nbsp;
<span class="powerShell__com">#&nbsp;Desc:&nbsp;Returns&nbsp;the&nbsp;actual&nbsp;(localized)&nbsp;name&nbsp;of&nbsp;the&nbsp;built-in&nbsp;Administrators&nbsp;group</span>&nbsp;
<span class="powerShell__com">#&nbsp;From:&nbsp;Taken&nbsp;from&nbsp;the&nbsp;AutoSPInstaller&nbsp;project:&nbsp;http://autospinstaller.codeplex.com</span>&nbsp;
<span class="powerShell__com">#&nbsp;====================================================================================</span>&nbsp;
&nbsp;
<span class="powerShell__keyword">Function</span>&nbsp;Get<span class="powerShell__operator">-</span>AdministratorsGroup&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">If</span>(<span class="powerShell__operator">!</span><span class="powerShell__variable">$builtinAdminGroup</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$builtinAdminGroup</span>&nbsp;=&nbsp;(<span class="powerShell__cmdlets">Get-WmiObject</span>&nbsp;<span class="powerShell__operator">-</span>Class&nbsp;Win32_Group&nbsp;<span class="powerShell__operator">-</span>computername&nbsp;<span class="powerShell__variable">$env</span>:COMPUTERNAME&nbsp;<span class="powerShell__operator">-</span><span class="powerShell__keyword">Filter</span>&nbsp;<span class="powerShell__string">&quot;SID='S-1-5-32-544'&nbsp;AND&nbsp;LocalAccount='True'&quot;</span>&nbsp;<span class="powerShell__operator">-</span>errorAction&nbsp;<span class="powerShell__string">&quot;Stop&quot;</span>).Name&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">Return</span>&nbsp;<span class="powerShell__variable">$builtinAdminGroup</span>&nbsp;
}&nbsp;
&nbsp;
<span class="powerShell__com">#&nbsp;====================================================================================</span>&nbsp;
<span class="powerShell__com">#&nbsp;ScriptBlock:&nbsp;AlterDB</span>&nbsp;
<span class="powerShell__com">#&nbsp;Description:&nbsp;PowerShell&nbsp;script&nbsp;block&nbsp;passed&nbsp;to&nbsp;the&nbsp;SQL&nbsp;server</span>&nbsp;
<span class="powerShell__com">#&nbsp;====================================================================================</span>&nbsp;
&nbsp;
[ScriptBlock]&nbsp;<span class="powerShell__variable">$global</span>:AlterDB&nbsp;=&nbsp;{&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">param</span>&nbsp;([string]&nbsp;<span class="powerShell__variable">$DBName</span>,[string]&nbsp;<span class="powerShell__variable">$LoginName</span>)&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Create&nbsp;our&nbsp;SQL&nbsp;query&nbsp;to&nbsp;fix&nbsp;db&nbsp;permissions</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;[string]&nbsp;<span class="powerShell__variable">$dbCommand</span>&nbsp;=&nbsp;<span class="powerShell__string">&quot;ALTER&nbsp;AUTHORIZATION&nbsp;ON&nbsp;DATABASE::[$DBname]&nbsp;TO&nbsp;[$LoginName];&quot;</span>&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Attempt&nbsp;to&nbsp;get&nbsp;SQL&nbsp;cmdlets</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$SQLSnapins</span>&nbsp;=&nbsp;<span class="powerShell__cmdlets">Get-PSSnapin</span>&nbsp;<span class="powerShell__operator">-</span>registered&nbsp;<span class="powerShell__operator">|</span>&nbsp;Where<span class="powerShell__operator">-</span>Object&nbsp;{<span class="powerShell__variable">$_</span>.Name&nbsp;<span class="powerShell__operator">-</span>like&nbsp;<span class="powerShell__string">&quot;SqlServer*&quot;</span>}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$SQLModules</span>&nbsp;=&nbsp;Get<span class="powerShell__operator">-</span>Module&nbsp;<span class="powerShell__operator">|</span>&nbsp;Where<span class="powerShell__operator">-</span>Object&nbsp;{<span class="powerShell__variable">$_</span>.Name&nbsp;<span class="powerShell__operator">-</span>like&nbsp;<span class="powerShell__string">&quot;SQL*&quot;</span>}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$SQLcmdlets</span>&nbsp;=&nbsp;<span class="powerShell__variable">$false</span>&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Check&nbsp;to&nbsp;see&nbsp;if&nbsp;a&nbsp;snapin&nbsp;for&nbsp;the&nbsp;SQL&nbsp;cmdlets&nbsp;exists&nbsp;(versions&nbsp;prior&nbsp;to&nbsp;SQL&nbsp;2012)</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">if</span>(<span class="powerShell__variable">$SQLSnapins</span>&nbsp;<span class="powerShell__operator">-</span>ne&nbsp;<span class="powerShell__variable">$null</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">foreach</span>(<span class="powerShell__variable">$Snapin</span>&nbsp;<span class="powerShell__keyword">in</span>&nbsp;<span class="powerShell__variable">$SQLSnapins</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__cmdlets">Add-PSSnapin</span>&nbsp;<span class="powerShell__variable">$Snapin</span>&nbsp;<span class="powerShell__operator">|</span>&nbsp;<span class="powerShell__cmdlets">Out-Null</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$SQLcmdlets</span>&nbsp;=&nbsp;<span class="powerShell__variable">$true</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;If&nbsp;no&nbsp;snapin,&nbsp;check&nbsp;for&nbsp;SQL&nbsp;module&nbsp;(SQL&nbsp;2012&#43;)</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">elseif</span>(<span class="powerShell__variable">$SQLModules</span>&nbsp;<span class="powerShell__operator">-</span>ne&nbsp;<span class="powerShell__variable">$null</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">foreach</span>(<span class="powerShell__variable">$Module</span>&nbsp;<span class="powerShell__keyword">in</span>&nbsp;<span class="powerShell__variable">$SQLModules</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Import<span class="powerShell__operator">-</span>Module&nbsp;SQLPS&nbsp;<span class="powerShell__operator">|</span>&nbsp;<span class="powerShell__cmdlets">Out-Null</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$SQLcmdlets</span>&nbsp;=&nbsp;<span class="powerShell__variable">$true</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Display&nbsp;warning&nbsp;if&nbsp;no&nbsp;SQL&nbsp;cmdlets&nbsp;available</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">else</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write<span class="powerShell__operator">-</span>Host&nbsp;<span class="powerShell__string">&quot;No&nbsp;SQL&nbsp;cmdlets&nbsp;found!&quot;</span>&nbsp;<span class="powerShell__operator">-</span>ForegroundColor&nbsp;Yellow&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;If&nbsp;SQL&nbsp;cmdlets&nbsp;available,&nbsp;execute&nbsp;our&nbsp;query</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">if</span>(<span class="powerShell__variable">$SQLcmdlets</span>&nbsp;<span class="powerShell__operator">-</span>eq&nbsp;<span class="powerShell__variable">$true</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Invoke<span class="powerShell__operator">-</span>SqlCmd&nbsp;<span class="powerShell__operator">-</span>Query&nbsp;<span class="powerShell__variable">$dbCommand</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
}&nbsp;
&nbsp;
<span class="powerShell__mlcom">&lt;#&nbsp;
.SYNOPSIS&nbsp;
Reprovisions&nbsp;the&nbsp;User&nbsp;Profile&nbsp;Synchronization&nbsp;Service&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;
.DESCRIPTION&nbsp;
This&nbsp;function&nbsp;fixes&nbsp;the&nbsp;SharePoint&nbsp;user&nbsp;profile&nbsp;synchronization&nbsp;service&nbsp;not&nbsp;starting&nbsp;by&nbsp;reprovisioning&nbsp;the&nbsp;User&nbsp;Profile&nbsp;Synchronization&nbsp;Service.&nbsp;DBcreator&nbsp;and&nbsp;SecurityAdmin&nbsp;access&nbsp;to&nbsp;the&nbsp;SharePoint&nbsp;SQL&nbsp;server&nbsp;are&nbsp;required,&nbsp;as&nbsp;well&nbsp;as&nbsp;local&nbsp;administrator&nbsp;on&nbsp;the&nbsp;SharePoint&nbsp;application&nbsp;server.&nbsp;You'll&nbsp;also&nbsp;need&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;invoke&nbsp;a&nbsp;remote&nbsp;PowerShell&nbsp;session&nbsp;on&nbsp;the&nbsp;SQL&nbsp;server.&nbsp;In&nbsp;addition,&nbsp;you&nbsp;will&nbsp;have&nbsp;to&nbsp;recreate&nbsp;your&nbsp;synchronization&nbsp;connections&nbsp;afterward&nbsp;(I&nbsp;hope&nbsp;to&nbsp;automate&nbsp;this&nbsp;in&nbsp;a&nbsp;future&nbsp;release&nbsp;of&nbsp;this&nbsp;script).&nbsp;
&nbsp;
.EXAMPLE&nbsp;
Fix-SPUserProfileSync&nbsp;-FarmAdmin&nbsp;&quot;DOMAIN\SP_farm&quot;&nbsp;-FarmPassword&nbsp;&quot;FARM_password&quot;&nbsp;-DBServer&nbsp;&quot;DBServerName&quot;&nbsp;
&nbsp;
This&nbsp;command&nbsp;takes&nbsp;three&nbsp;required&nbsp;parameters&nbsp;and&nbsp;resets&nbsp;the&nbsp;synchronisation&nbsp;database.&nbsp;&quot;DBServerName&quot;&nbsp;can&nbsp;be&nbsp;an&nbsp;alias&nbsp;or&nbsp;the&nbsp;actual&nbsp;SQL&nbsp;server&nbsp;name.&nbsp;
&nbsp;
.NOTES&nbsp;
NAME:&nbsp;Fix-SPUserProfileSync&nbsp;
AUTHOR:&nbsp;Wes&nbsp;Kroesbergen&nbsp;
CAVEATS:&nbsp;DBcreator&nbsp;and&nbsp;SecurityAdmin&nbsp;access&nbsp;to&nbsp;the&nbsp;SharePoint&nbsp;SQL&nbsp;server&nbsp;are&nbsp;required,&nbsp;as&nbsp;well&nbsp;as&nbsp;local&nbsp;administrator&nbsp;on&nbsp;the&nbsp;SharePoint&nbsp;application&nbsp;server.&nbsp;You'll&nbsp;also&nbsp;need&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;invoke&nbsp;a&nbsp;remote&nbsp;PowerShell&nbsp;session&nbsp;on&nbsp;the&nbsp;SQL&nbsp;server.&nbsp;In&nbsp;addition,&nbsp;you&nbsp;will&nbsp;have&nbsp;to&nbsp;recreate&nbsp;your&nbsp;synchronization&nbsp;connections&nbsp;afterward&nbsp;(I&nbsp;hope&nbsp;to&nbsp;automate&nbsp;this&nbsp;in&nbsp;a&nbsp;future&nbsp;release&nbsp;of&nbsp;this&nbsp;script).&nbsp;
&nbsp;
.LINK&nbsp;
http://www.kroesbergens.com&nbsp;
#&gt;</span>&nbsp;
&nbsp;
<span class="powerShell__keyword">Function</span>&nbsp;Fix<span class="powerShell__operator">-</span>SPUserProfileSync&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">Param</span>([Parameter(Position=0,Mandatory=<span class="powerShell__variable">$true</span>)][string]&nbsp;<span class="powerShell__variable">$FarmAdmin</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Parameter(Position=1,Mandatory=<span class="powerShell__variable">$true</span>)][string]&nbsp;<span class="powerShell__variable">$FarmPassword</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Parameter(Position=2,Mandatory=<span class="powerShell__variable">$true</span>)][string]&nbsp;<span class="powerShell__variable">$DBServer</span>)&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$FarmPassword</span>&nbsp;=&nbsp;<span class="powerShell__cmdlets">ConvertTo-SecureString</span>&nbsp;<span class="powerShell__variable">$FarmPassword</span>&nbsp;<span class="powerShell__operator">-</span>AsPlainText&nbsp;<span class="powerShell__operator">-</span>Force&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$farmAcctDomain</span>,<span class="powerShell__variable">$farmAcctUser</span>&nbsp;=&nbsp;<span class="powerShell__variable">$farmAdmin</span>&nbsp;<span class="powerShell__operator">-</span>Split&nbsp;<span class="powerShell__string">&quot;\\&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$builtinAdminGroup</span>&nbsp;=&nbsp;Get<span class="powerShell__operator">-</span>AdministratorsGroup&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Elevate&nbsp;privileges&nbsp;if&nbsp;necessary</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">Try</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;([ADSI]<span class="powerShell__string">&quot;WinNT://$env:COMPUTERNAME/$builtinAdminGroup,group&quot;</span>).Add(<span class="powerShell__string">&quot;WinNT://$farmAcctDomain/$farmAcctUser&quot;</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">If</span>&nbsp;(<span class="powerShell__operator">-</span>not&nbsp;<span class="powerShell__variable">$</span>?)&nbsp;{<span class="powerShell__keyword">Throw</span>}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Restart&nbsp;the&nbsp;SPTimerV4&nbsp;service&nbsp;if&nbsp;it's&nbsp;running,&nbsp;so&nbsp;it&nbsp;will&nbsp;pick&nbsp;up&nbsp;the&nbsp;new&nbsp;credential</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">If</span>&nbsp;((<span class="powerShell__cmdlets">Get-Service</span>&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;SPTimerV4).Status&nbsp;<span class="powerShell__operator">-</span>eq&nbsp;<span class="powerShell__string">&quot;Running&quot;</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write<span class="powerShell__operator">-</span>Host&nbsp;<span class="powerShell__operator">-</span>ForegroundColor&nbsp;White&nbsp;<span class="powerShell__string">&quot;&nbsp;-&nbsp;Restarting&nbsp;SharePoint&nbsp;Timer&nbsp;Service...&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__cmdlets">Restart-Service</span>&nbsp;SPTimerV4&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">Catch</span>&nbsp;{Write<span class="powerShell__operator">-</span>Host&nbsp;<span class="powerShell__operator">-</span>ForegroundColor&nbsp;White&nbsp;<span class="powerShell__string">&quot;&nbsp;-&nbsp;$FarmAdmin&nbsp;is&nbsp;already&nbsp;a&nbsp;member&nbsp;of&nbsp;`&quot;</span><span class="powerShell__variable">$builtinAdminGroup</span>`<span class="powerShell__string">&quot;.&quot;</span>}&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Stop&nbsp;the&nbsp;Timer&nbsp;Service</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__cmdlets">Stop-Service</span>&nbsp;sptimerv4&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Get&nbsp;the&nbsp;Sync&nbsp;DB&nbsp;and&nbsp;clear&nbsp;the&nbsp;data</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$SyncDB</span>=Get<span class="powerShell__operator">-</span>SPDatabase&nbsp;<span class="powerShell__operator">|</span>&nbsp;Where<span class="powerShell__operator">-</span>Object&nbsp;{<span class="powerShell__variable">$_</span>.<span class="powerShell__alias">Type</span>&nbsp;<span class="powerShell__operator">-</span>eq&nbsp;<span class="powerShell__string">&quot;Microsoft.Office.Server.Administration.SynchronizationDatabase&quot;</span>}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$SyncDB</span>.Unprovision()&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$SyncDB</span>.Status=<span class="powerShell__string">'Offline'</span>&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Reset&nbsp;the&nbsp;Sync&nbsp;info&nbsp;in&nbsp;the&nbsp;User&nbsp;Profile&nbsp;Application</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$UPA</span>=Get<span class="powerShell__operator">-</span>SPServiceApplication&nbsp;<span class="powerShell__operator">|</span>&nbsp;Where<span class="powerShell__operator">-</span>Object&nbsp;{<span class="powerShell__variable">$_</span>.TypeName&nbsp;<span class="powerShell__operator">-</span>match&nbsp;<span class="powerShell__string">&quot;User&nbsp;Profile&nbsp;Service&nbsp;Application&quot;</span>}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$UPA</span>.ResetSynchronizationMachine()&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$UPA</span>.ResetSynchronizationDatabase()&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Reprovision&nbsp;the&nbsp;Sync&nbsp;DB</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$SyncDB</span>.Provision()&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$UPSinstance</span>&nbsp;=&nbsp;Get<span class="powerShell__operator">-</span>SPServiceInstance&nbsp;<span class="powerShell__operator">|</span>&nbsp;Where<span class="powerShell__operator">-</span>Object&nbsp;{<span class="powerShell__variable">$_</span>.TypeName&nbsp;<span class="powerShell__operator">-</span>match&nbsp;<span class="powerShell__string">&quot;User&nbsp;Profile&nbsp;Synchronization&nbsp;Service&quot;</span>&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$UPA</span>.SetSynchronizationMachine(<span class="powerShell__variable">$env</span>:COMPUTERNAME,&nbsp;<span class="powerShell__variable">$UPSinstance</span>.ID,&nbsp;<span class="powerShell__variable">$FarmAdmin</span>,&nbsp;<span class="powerShell__variable">$FarmPassword</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;Start<span class="powerShell__operator">-</span>SPServiceInstance&nbsp;<span class="powerShell__operator">-</span>Identity&nbsp;<span class="powerShell__variable">$UPSinstance</span>.ID&nbsp;&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Before&nbsp;we&nbsp;try&nbsp;to&nbsp;connect&nbsp;remotely,&nbsp;let's&nbsp;confirm&nbsp;DBServer&nbsp;is&nbsp;not&nbsp;an&nbsp;alias</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$AliasPath</span>&nbsp;=&nbsp;&quot;HKLM:\Software\Microsoft\MSSQLServer\Client\ConnectTo\&quot;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$Item</span>&nbsp;=&nbsp;<span class="powerShell__cmdlets">Get-ItemProperty</span>&nbsp;<span class="powerShell__operator">-</span>Path&nbsp;<span class="powerShell__variable">$AliasPath</span>&nbsp;<span class="powerShell__operator">-</span>Name&nbsp;<span class="powerShell__variable">$DBServer</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">if</span>&nbsp;((<span class="powerShell__cmdlets">test-path</span>&nbsp;<span class="powerShell__operator">-</span>path&nbsp;<span class="powerShell__variable">$AliasPath</span>)&nbsp;<span class="powerShell__operator">-</span>eq&nbsp;<span class="powerShell__variable">$True</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write<span class="powerShell__operator">-</span>host&nbsp;<span class="powerShell__string">&quot;Alias&nbsp;exists!&quot;</span>&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;If&nbsp;object&nbsp;exists,&nbsp;we&nbsp;parse&nbsp;the&nbsp;definitions&nbsp;and&nbsp;retrieve&nbsp;the&nbsp;one&nbsp;with&nbsp;a&nbsp;TCP&nbsp;alias&nbsp;value</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$AliasProperties</span>&nbsp;=&nbsp;(<span class="powerShell__variable">$Item</span>&nbsp;<span class="powerShell__operator">|</span>&nbsp;<span class="powerShell__cmdlets">Get-Member</span>&nbsp;<span class="powerShell__operator">|</span>&nbsp;Where<span class="powerShell__operator">-</span>Object&nbsp;{<span class="powerShell__variable">$_</span>.Definition&nbsp;<span class="powerShell__operator">-</span>like&nbsp;<span class="powerShell__string">&quot;*DBMSSOCN*&quot;</span>}).Definition.Split(<span class="powerShell__string">&quot;,&quot;</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__variable">$DBServer</span>&nbsp;=&nbsp;<span class="powerShell__variable">$AliasProperties</span>[1]&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write<span class="powerShell__operator">-</span>Host&nbsp;<span class="powerShell__string">&quot;Actual&nbsp;server&nbsp;name&nbsp;is&nbsp;$DBServer!&quot;</span>&nbsp;<span class="powerShell__operator">-</span>ForegroundColor&nbsp;Yellow&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Make&nbsp;sure&nbsp;the&nbsp;farm&nbsp;account&nbsp;has&nbsp;DBO&nbsp;rights&nbsp;to&nbsp;Sync&nbsp;DB</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;Invoke<span class="powerShell__operator">-</span>Command&nbsp;<span class="powerShell__operator">-</span>ComputerName&nbsp;<span class="powerShell__variable">$DBServer</span>&nbsp;<span class="powerShell__operator">-</span>ScriptBlock&nbsp;<span class="powerShell__variable">$AlterDB</span>&nbsp;<span class="powerShell__operator">-</span>ArgumentList&nbsp;<span class="powerShell__variable">$SyncDB</span>,<span class="powerShell__variable">$FarmAdmin</span>&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Start&nbsp;the&nbsp;Timer&nbsp;Service</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__cmdlets">Start-Service</span>&nbsp;sptimerv4&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Remove&nbsp;farm&nbsp;account&nbsp;from&nbsp;local&nbsp;admin</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;Write<span class="powerShell__operator">-</span>Host&nbsp;<span class="powerShell__operator">-</span>ForegroundColor&nbsp;White&nbsp;<span class="powerShell__string">&quot;&nbsp;-&nbsp;Removing&nbsp;$FarmAdmin&nbsp;from&nbsp;local&nbsp;group&nbsp;`&quot;</span><span class="powerShell__variable">$builtinAdminGroup</span>`<span class="powerShell__string">&quot;...&quot;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">try</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;([ADSI]<span class="powerShell__string">&quot;WinNT://$env:COMPUTERNAME/$builtinAdminGroup,group&quot;</span>).Remove(<span class="powerShell__string">&quot;WinNT://$farmAcctDomain/$farmAcctUser&quot;</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">If</span>&nbsp;(<span class="powerShell__operator">-</span>not&nbsp;<span class="powerShell__variable">$</span>?)&nbsp;{<span class="powerShell__keyword">throw</span>}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__keyword">catch</span>&nbsp;{Write<span class="powerShell__operator">-</span>Host&nbsp;<span class="powerShell__operator">-</span>ForegroundColor&nbsp;White&nbsp;<span class="powerShell__string">&quot;&nbsp;-&nbsp;$FarmAdmin&nbsp;already&nbsp;removed&nbsp;from&nbsp;`&quot;</span><span class="powerShell__variable">$builtinAdminGroup</span>.`<span class="powerShell__string">&quot;&quot;</span>}&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__com">#&nbsp;Restart&nbsp;SPTimerV4&nbsp;so&nbsp;it&nbsp;can&nbsp;now&nbsp;run&nbsp;under&nbsp;non-local&nbsp;Admin&nbsp;privileges&nbsp;and&nbsp;avoid&nbsp;Health&nbsp;Analyzer&nbsp;warning</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;Write<span class="powerShell__operator">-</span>Host&nbsp;<span class="powerShell__operator">-</span>ForegroundColor&nbsp;White&nbsp;<span class="powerShell__string">&quot;&nbsp;-&nbsp;Starting&nbsp;SharePoint&nbsp;Timer&nbsp;Service...&quot;</span>&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="powerShell__cmdlets">Restart-Service</span>&nbsp;SPTimerV4&nbsp;
}</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>

        </div>
    </body>
</html>